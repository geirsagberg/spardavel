name: Auto-merge Approved PRs

on:
  pull_request_review:
    types: [submitted]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run if the review is an approval
    if: github.event.review.state == 'APPROVED'
    steps:
      - name: Check if PR is approved and merge
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "PR #${PR_NUMBER} has been approved, attempting to merge"

          # Verify PR has approval status
          REVIEW_STATE=$(gh pr view "${PR_NUMBER}" --repo "${REPO}" \
            --json reviewDecision --jq '.reviewDecision')

          if [ "$REVIEW_STATE" != "APPROVED" ]; then
            echo "PR does not have approval status, skipping merge"
            exit 0
          fi

          # Check if PR is mergeable
          # CLEAN: All checks passed, ready to merge
          # UNSTABLE: Some checks failed but merge is allowed (e.g., optional)
          PR_STATE=$(gh pr view "${PR_NUMBER}" --repo "${REPO}" \
            --json mergeStateStatus --jq '.mergeStateStatus')

          if [ "$PR_STATE" = "CLEAN" ] || [ "$PR_STATE" = "UNSTABLE" ]; then
            echo "PR is mergeable, proceeding with merge"
            # Note: --delete-branch only deletes the head branch if it's not
            # the default branch and the user has permissions
            gh pr merge "${PR_NUMBER}" --repo "${REPO}" --squash \
              --delete-branch
          else
            echo "PR not in mergeable state: $PR_STATE, skipping merge"
            exit 0
          fi
